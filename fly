#!/usr/bin/env bash

# Eclipsn Launch Script - "fly"
# Runs brain (FastAPI), gateway (Express), and frontend (Next.js) concurrently
# with proper error handling, logging, and graceful shutdown

set -euo pipefail

# Color codes for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly MAGENTA='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m' # No Color

# Project root directory
readonly PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly LOG_DIR="${PROJECT_ROOT}/.logs"
readonly PID_FILE="${PROJECT_ROOT}/.fly.pids"

# Service PIDs
BRAIN_PID=""
GATEWAY_PID=""
FRONTEND_PID=""

# Cleanup function for graceful shutdown
cleanup() {
    echo -e "\n${YELLOW}ğŸ›‘ Shutting down services...${NC}"
    
    if [[ -f "$PID_FILE" ]]; then
        while IFS= read -r pid; do
            if [[ -n "$pid" ]] && kill -0 "$pid" 2>/dev/null; then
                echo -e "${CYAN}  Stopping process tree for PID $pid${NC}"
                # Kill the process and its children
                pkill -TERM -P "$pid" 2>/dev/null || true
                kill -TERM "$pid" 2>/dev/null || true
                # Wait briefly for graceful shutdown
                sleep 0.5
                # Force kill if still running
                kill -9 "$pid" 2>/dev/null || true
            fi
        done < "$PID_FILE"
        rm -f "$PID_FILE"
    fi
    
    echo -e "${GREEN}âœ… All services stopped${NC}"
    exit 0
}

# Set up signal handlers
trap cleanup SIGINT SIGTERM EXIT

# Create log directory
mkdir -p "$LOG_DIR"

# Prefixed logger function
log_with_prefix() {
    local prefix="$1"
    local color="$2"
    while IFS= read -r line; do
        echo -e "${color}[${prefix}]${NC} ${line}"
    done
}

# Check if required commands exist
check_dependencies() {
    local missing_deps=()
    
    command -v node >/dev/null 2>&1 || missing_deps+=("node")
    command -v npm >/dev/null 2>&1 || missing_deps+=("npm")
    command -v python3 >/dev/null 2>&1 || missing_deps+=("python3")
    command -v poetry >/dev/null 2>&1 || missing_deps+=("poetry")
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        echo -e "${RED}âŒ Missing dependencies: ${missing_deps[*]}${NC}"
        echo -e "${YELLOW}Please install the missing dependencies and try again.${NC}"
        exit 1
    fi
}

# Check if .env file exists
check_env_file() {
    if [[ ! -f "${PROJECT_ROOT}/.env" ]]; then
        echo -e "${RED}âŒ .env file not found${NC}"
        echo -e "${YELLOW}Please copy .env.example to .env and configure it.${NC}"
        exit 1
    fi
}

# Check if node_modules exist for Node.js services
check_node_modules() {
    local service="$1"
    local service_path="${PROJECT_ROOT}/${service}"
    
    if [[ ! -d "${service_path}/node_modules" ]]; then
        echo -e "${YELLOW}âš ï¸  node_modules not found in ${service}, running npm install...${NC}"
        (cd "$service_path" && npm install)
    fi
}

# Check if Python virtual environment exists
check_python_env() {
    local brain_path="${PROJECT_ROOT}/brain"
    
    if [[ ! -d "${brain_path}/.venv" ]]; then
        echo -e "${YELLOW}âš ï¸  Python virtual environment not found, running poetry install...${NC}"
        (cd "$brain_path" && poetry install)
    fi
}

# Start a service in the background
start_service() {
    local name="$1"
    local color="$2"
    local dir="$3"
    shift 3
    local log_file="${LOG_DIR}/${name}.log"
    
    echo -e "${color}ğŸš€ Starting ${name}...${NC}"
    
    # Start the service in a subshell with proper output handling
    (
        cd "$dir" || exit 1
        
        # Set environment for unbuffered output
        export PYTHONUNBUFFERED=1
        export FORCE_COLOR=1
        export NPM_CONFIG_COLOR=always
        
        # Execute the command directly (not through bash -c)
        # This preserves the proper terminal behavior
        exec "$@" 2>&1
    ) | while IFS= read -r line; do
        echo -e "${color}[${name}]${NC} ${line}"
        echo "[${name}] ${line}" >> "$log_file"
    done &
    
    local pid=$!
    echo "$pid" >> "$PID_FILE"
    
    # Store PID in appropriate variable
    case "$name" in
        "BRAIN")
            BRAIN_PID=$pid
            ;;
        "GATEWAY")
            GATEWAY_PID=$pid
            ;;
        "FRONTEND")
            FRONTEND_PID=$pid
            ;;
    esac
    
    echo -e "${color}  ${name} started with PID ${pid}${NC}"
}

# Wait for a service to be ready
wait_for_service() {
    local name="$1"
    local url="$2"
    local max_attempts=30
    local attempt=0
    
    echo -e "${CYAN}â³ Waiting for ${name} to be ready...${NC}"
    
    while [[ $attempt -lt $max_attempts ]]; do
        if curl -s -f -o /dev/null "$url" 2>/dev/null; then
            echo -e "${GREEN}âœ… ${name} is ready${NC}"
            return 0
        fi
        attempt=$((attempt + 1))
        sleep 1
    done
    
    echo -e "${RED}âŒ ${name} failed to start within ${max_attempts} seconds${NC}"
    return 1
}

# Main execution
main() {
    echo -e "${MAGENTA}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘        Eclipsn Launch Script          â•‘"
    echo "â•‘              'fly' ğŸš€                 â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    
    # Pre-flight checks
    echo -e "${BLUE}ğŸ” Running pre-flight checks...${NC}"
    check_dependencies
    check_env_file
    check_node_modules "gateway"
    check_node_modules "frontend"
    check_python_env
    echo -e "${GREEN}âœ… Pre-flight checks passed${NC}\n"
    
    # Clean up old PID file
    rm -f "$PID_FILE"
    
    # Start services
    echo -e "${BLUE}ğŸš€ Launching services...${NC}\n"
    
    # Start Brain (FastAPI on port 8000)
    start_service "BRAIN" "$MAGENTA" "${PROJECT_ROOT}/brain" \
        poetry run uvicorn src.main:app --reload --port 8000
    
    sleep 2
    
    # Start Gateway (Express on port 4000)
    start_service "GATEWAY" "$CYAN" "${PROJECT_ROOT}/gateway" \
        npm run dev
    
    sleep 2
    
    # Start Frontend (Next.js on port 3000)
    start_service "FRONTEND" "$GREEN" "${PROJECT_ROOT}/frontend" \
        npm run dev
    
    echo -e "\n${BLUE}â³ Waiting for services to initialize...${NC}\n"
    sleep 3
    
    # Display service URLs
    echo -e "${MAGENTA}"
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘        Services Running               â•‘"
    echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
    echo "â•‘  ğŸ§  Brain:    http://localhost:8000   â•‘"
    echo "â•‘  ğŸŒ Gateway:  http://localhost:4000   â•‘"
    echo "â•‘  ğŸ’» Frontend: http://localhost:3000   â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo -e "${NC}"
    
    echo -e "${YELLOW}ğŸ“ Logs are being written to: ${LOG_DIR}${NC}"
    echo -e "${YELLOW}Press Ctrl+C to stop all services${NC}\n"
    
    # Wait for all background jobs
    wait
}

# Run main function
main
